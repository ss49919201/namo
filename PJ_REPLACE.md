# プロジェクトリプレイス仕様書

## 1. プロジェクト概要

### システム名
**門徒情報管理システム (Monto Information Management System)**

### 目的
仏教寺院における門徒（信徒世帯）の基本情報、家族構成、故人情報、法要スケジュールを総合的に管理するWebアプリケーション

### 現在の技術スタック
- **フレームワーク**: HonoX (Hono + ファイルベースルーティング)
- **ランタイム**: Cloudflare Workers
- **データベース**: Cloudflare D1 (SQLite) + Drizzle ORM
- **フロントエンド**: JSX + TailwindCSS v4
- **ビルドツール**: Vite
- **言語**: TypeScript

## 2. アーキテクチャ仕様

### アーキテクチャパターン
**レイヤードアーキテクチャ + CQRS（Command Query Responsibility Segregation）**

```
app/routes/          # プレゼンテーション層（HonoXファイルベースルーティング）
├── usecase/         # ビジネスロジック層（書き込み操作）
├── queryService/    # クエリ層（読み取り専用操作）
├── infra/db/        # データアクセス層（Drizzle ORM）
└── result/          # エラーハンドリング層（Result<T>パターン）
```

### 設計原則
1. **関心の分離**: 各層の責務を明確に分離
2. **依存性の方向**: 上位層が下位層に依存、逆依存なし
3. **型安全性**: TypeScriptによる厳格な型チェック
4. **エラーハンドリング**: Result<T>パターンによる統一的な例外処理

## 3. データベース仕様

### データベース構成
- **プロバイダー**: Cloudflare D1 (SQLiteベース)
- **ORM**: Drizzle ORM
- **マイグレーション**: Drizzle Kit

### 現在のスキーマ（参考情報）

⚠️ **重要**: 以下は現在実装されているスキーマです。リプレイス時には要件に合わせて**スキーマを設計し直す**前提です。

#### 現在のテーブル構成
- **montos**: 門徒基本情報（id, head_name, address, phone, note）
- **monto_families**: 家族構成（id, monto_id, name, relationship, note）
- **deceased_person**: 故人情報（id, monto_id, name, homyo, ingou, meinichi, kyonen, note）
- **hoyo**: 法要情報（id, monto_id, deceased_person_id, hoyo_type, nenki, scheduled_at, note）
- **users**: システムユーザー（id, name, password_hash, role, last_login）

#### 現在のスキーマの課題
1. **typo**: `hoyo.deceased_person_id`がコードでは`deceasePersondId`となっている
2. **日付型**: 日付項目がTEXT型で格納されている
3. **バリデーション**: テーブルレベルでの制約が不十分
4. **インデックス**: 検索パフォーマンス用のインデックスが未設定
5. **正規化**: 一部の項目で正規化が不十分

### リプレイス時のスキーマ設計方針
- 門徒情報管理の業務要件に最適化された設計
- 適切なデータ型とバリデーション制約
- 検索パフォーマンスを考慮したインデックス設計
- 将来の機能拡張を考慮した柔軟な構造

## 4. API仕様

### エンドポイント設計（ファイルベースルーティング）

#### 4.1 認証関連
- `GET /login` - ログインフォーム表示
- `POST /login` - ログイン処理（**未実装**）
- `GET /register` - 登録フォーム表示
- `POST /register` - ユーザー登録処理（**未実装**）

#### 4.2 門徒管理
- `GET /montos` - 門徒一覧表示
- `GET /montos/new` - 新規門徒追加フォーム
- `POST /montos` - 門徒新規作成（**未実装**）
- `GET /montos/edit/[id]` - 門徒編集フォーム
- `PUT /montos/[id]` - 門徒情報更新（**未実装**）
- `DELETE /montos/[id]` - 門徒削除（**未実装**）

#### 4.3 家族構成管理（**要実装**）
- `GET /montos/[id]/families` - 家族一覧
- `POST /montos/[id]/families` - 家族追加
- `PUT /families/[id]` - 家族情報更新
- `DELETE /families/[id]` - 家族削除

#### 4.4 故人・法要管理（**要実装**）
- `GET /montos/[id]/deceased` - 故人一覧
- `POST /montos/[id]/deceased` - 故人追加
- `GET /hoyo` - 法要スケジュール一覧
- `POST /hoyo` - 法要予定追加

### レスポンス形式
- **成功**: `{ ok: true, data: T }`
- **エラー**: `{ ok: false, error: Error }`

## 5. ビジネスロジック仕様

### 実装済みユースケース

#### 5.1 門徒管理
- **createMonto**: 門徒新規作成
  - 入力: `{ headName, address, phone, note? }`
  - 出力: `{ id, headName, address, phone, note }`
- **updateMonto**: 門徒情報更新（部分更新対応）
  - 入力: `{ id, headName?, address?, phone?, note? }`
  - 出力: 更新後の完全なレコード
- **deleteMonto**: 門徒削除
  - 入力: `{ id }`
  - 出力: `{ deletedId }`

#### 5.2 クエリサービス
- **findMontos**: 門徒一覧取得
  - 入力: `{ searchTerm?, limit?, offset? }`
  - 機能: マルチフィールド検索、ページネーション
- **findMontoById**: 門徒詳細取得
  - 入力: `{ id }`
  - 出力: 単一レコードまたはnull

### 未実装の業務要件

#### 5.3 家族構成管理
- 家族構成員のCRUD操作
- 続柄の管理（親、子、配偶者等）

#### 5.4 故人・法名管理
- 故人情報のCRUD操作
- 法名・院号の管理
- 命日・享年の管理

#### 5.5 法要スケジューリング
- 年忌法要の自動計算（初七日、四十九日、一周忌等）
- 法要予定の管理
- 通知機能

#### 5.6 認証・認可
- ユーザー認証機能
- ロールベースアクセス制御
- セッション管理

## 6. フロントエンド仕様

### UI/UXデザイン

#### 6.1 デザインシステム
- **CSSフレームワーク**: TailwindCSS v4
- **カラーパレット**: Indigo系（プライマリー）、Gray系（セカンダリー）
- **レイアウト**: カード形式、グリッドシステム
- **レスポンシブ**: モバイルファースト設計

#### 6.2 コンポーネント設計
- **アーキテクチャ**: Islands Architecture
- **SSR**: 基本的なページ構造
- **クライアントサイド**: インタラクティブコンポーネントのみ

#### 6.3 実装済み画面
1. **ホームページ** (`/`)
2. **ログイン画面** (`/login`)
3. **ユーザー登録画面** (`/register`)
4. **門徒一覧画面** (`/montos`)
5. **門徒新規追加画面** (`/montos/new`)
6. **門徒編集画面** (`/montos/edit/[id]`)
7. **エラーページ** (`/_404`, `/_error`)

#### 6.4 フォーム設計
- **バリデーション**: HTML5標準 + カスタムバリデーション
- **ユーザビリティ**: オートコンプリート、適切なinput type
- **アクセシビリティ**: ラベル設定、スクリーンリーダー対応

## 7. 開発・運用仕様

### 開発コマンド
```bash
# 依存関係インストール
npm install

# 開発サーバー起動
npm run dev

# データベースマイグレーション
npm run drizzle:generate  # マイグレーション生成
npm run migrate:local     # ローカル適用
npm run migrate          # リモート適用

# ビルド・デプロイ
npm run build
npm run preview
npm run deploy
```

### 環境設定
- **開発環境**: ローカルD1データベース
- **本番環境**: Cloudflare Workers + D1
- **設定ファイル**: `wrangler.jsonc`

### デプロイメント
- **プラットフォーム**: Cloudflare Workers
- **エッジコンピューティング**: グローバル配信
- **サーバーレス**: スケーラブルなアーキテクチャ

## 8. パフォーマンス・セキュリティ考慮

### パフォーマンス
- **エッジコンピューティング**: Cloudflare Workers
- **データベース最適化**: インデックス設計（要改善）
- **フロントエンド最適化**: Islands Architecture

### セキュリティ
- **SQLインジェクション対策**: Drizzle ORM
- **XSS対策**: JSXによる自動エスケープ
- **認証**: パスワードハッシュ化（実装要）
- **認可**: ロールベースアクセス制御（実装要）

## 9. 実装状況と課題

### 実装済み機能
✅ **データベーススキーマ設計**
✅ **基本的なレイヤードアーキテクチャ**
✅ **門徒基本情報のCRUD（バックエンド）**
✅ **検索・ページネーション機能**
✅ **フロントエンド画面構造**
✅ **Result<T>パターンによるエラーハンドリング**

### 未実装・要改善
❌ **HTTP POST処理の実装**
❌ **認証・認可システム**
❌ **家族構成管理機能**
❌ **故人・法要管理機能**
❌ **バリデーション強化**
❌ **コンポーネント共通化**
❌ **テスト実装**
❌ **ログ・監視システム**

### 設計上の課題
⚠️ **フロントエンド実装が仕様と乖離**（ユーザー管理画面として実装）
⚠️ **D1データベース設定がコメントアウト状態**
⚠️ **typo修正必要**（hoyo.deceasePersondId → deceasedPersonId）

## 10. リプレイス戦略の推奨

### Phase 1: 基盤整備
1. POST処理の実装
2. 認証・認可システムの構築
3. バリデーション強化
4. エラーハンドリング改善

### Phase 2: 門徒管理機能完成
1. 門徒基本情報管理の完全実装
2. 家族構成管理機能の追加
3. 検索・フィルタリング機能の強化

### Phase 3: 故人・法要管理
1. 故人情報管理機能
2. 法要スケジューリング機能
3. 年忌法要自動計算機能

### Phase 4: 運用機能強化
1. レポート機能
2. データインポート・エクスポート
3. バックアップ・リストア機能
4. 監視・ログ機能

この仕様書に基づいて、段階的なリプレイスを実施することで、仏教寺院の門徒情報管理に特化した高品質なWebアプリケーションを構築できます。